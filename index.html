<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الإنتاج - Production Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #605dc6 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #6b60e0 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #667eea;
            color: white;
            border-color: white;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #4d9bb7 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .notification-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .notification-item {
            padding: 10px;
            margin: 10px 0;
            background: white;
            border-radius: 5px;
            border-right: 4px solid #dc3545;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: right;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            text-align: right;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-list {
            list-style: none;
            margin: 20px 0;
        }

        .file-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item.uploaded {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
<link rel="icon" href="bjplogo.jpg?v=1">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> BJP  - نظام إدارة الإنتاج </h1>
            <p>Production Management System - Integrated Solution</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('upload')">تحميل الملفات</button>
            <button class="tab" onclick="showTab('notifications')"> التنبيهات</button>
            <button class="tab" onclick="showTab('orders')"> فحص الطلبات</button>
            <button class="tab" onclick="showTab('expiry')"> المواد قرب الانتهاء</button>
            <button class="tab" onclick="showTab('reports')"> التقارير</button>
            <button class="tab" onclick="showTab('productivity')"> الإنتاجية</button>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div id="upload" class="section active">
                <div class="card">
                    <div class="card-header">تحميل ملفات البيانات</div>
                    
                    <div class="alert alert-success" id="uploadSuccess">
                        ✓ تم تحميل الملف بنجاح!
                    </div>
                    
                    <div class="alert alert-danger" id="uploadError">
                        ✗ خطأ في تحميل الملف
                    </div>

                    <ul class="file-list">
                        <li class="file-item" id="file1-status">
                            <span>1. المواد الخام اللازمة للانتاج product 2</span>
                            <button class="btn btn-primary" onclick="document.getElementById('file1').click()">تحميل</button>
                            <input type="file" id="file1" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'product2')">
                        </li>
                        <li class="file-item" id="file2-status">
                            <span>2. المواد الخام اللازمة للانتاج product 14</span>
                            <button class="btn btn-primary" onclick="document.getElementById('file2').click()">تحميل</button>
                            <input type="file" id="file2" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'product14')">
                        </li>
                        <li class="file-item" id="file3-status">
                            <span>3. مبيعات حسب الاصناف</span>
                            <button class="btn btn-primary" onclick="document.getElementById('file3').click()">تحميل</button>
                            <input type="file" id="file3" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'sales')">
                        </li>
                        <li class="file-item" id="file4-status">
                            <span>4. صلاحيات الدفعات لكل مستودع</span>
                            <button class="btn btn-primary" onclick="document.getElementById('file4').click()">تحميل</button>
                            <input type="file" id="file4" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'batches')">
                        </li>
                        <li class="file-item" id="file5-status">
                            <span>5. ارصدة البضائع</span>
                            <button class="btn btn-primary" onclick="document.getElementById('file5').click()">تحميل</button>
                            <input type="file" id="file5" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'stock')">
                        </li>
                        <li class="file-item" id="file6-status">
                            <span>6. RMG Mixer Preparation (Monday)</span>
                            <button class="btn btn-primary" onclick="document.getElementById('file6').click()">تحميل</button>
                            <input type="file" id="file6" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'monday_rmg')">
                        </li>
                        <li class="file-item" id="file7-status">
                            <span>7. Powder Filling Line (Monday)</span>
                            <button class="btn btn-primary" onclick="document.getElementById('file7').click()">تحميل</button>
                            <input type="file" id="file7" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'monday_powder')">
                        </li>
                    </ul>

                    <div class="progress-bar">
                        <div class="progress-fill" id="uploadProgress" style="width: 0%"></div>
                    </div>
                    <p style="text-align: center; margin-top: 10px;">
                        <span id="uploadedCount">0</span> من 7 ملفات محملة
                    </p>
                </div>
            </div>

            <!-- Notifications Section -->
            <div id="notifications" class="section">
                <div class="card">
                    <div class="card-header">التنبيهات والإشعارات</div>
                    
                    <div class="notification-box">
                        <h3 style="margin-bottom: 15px;"> تنبيهات نقاط إعادة الطلب</h3>
                        <div id="reorderAlerts"></div>
                    </div>

                    <div class="notification-box" style="border-color: #28a745; background: #d4edda;">
                        <h3 style="margin-bottom: 15px;"> تنبيهات نقاط إعادة طلب المنتجات</h3>
                        <div id="productReorderAlerts"></div>
                    </div>

                    <button class="btn btn-primary" onclick="checkReorderPoints()"> تحديث التنبيهات</button>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="section">
                <div class="card">
                    <div class="card-header">فحص طلبات المبيعات الجديدة</div>
                    
                    <div class="input-group">
                        <label>اسم المنتج أو رقم الصنف:</label>
                        <input type="text" id="orderProduct" placeholder="أدخل اسم المنتج">
                    </div>

                    <div class="input-group">
                        <label>الكمية المطلوبة:</label>
                        <input type="number" id="orderQuantity" placeholder="أدخل الكمية">
                    </div>

                    <div class="input-group">
                        <label>رقم الدفعة (اختياري):</label>
                        <input type="text" id="orderBatch" placeholder="رقم الدفعة">
                    </div>

                    <button class="btn btn-primary" onclick="checkOrder()">فحص الطلب</button>
                    <button class="btn btn-success" onclick="addOrderToQueue()">إضافة إلى قائمة الطلبات</button>

                    <div id="orderResult" style="margin-top: 20px;"></div>

                    <div class="card" style="margin-top: 30px;">
                        <div class="card-header">قائمة الطلبات المعلقة</div>
                        <div id="orderQueue"></div>
                        <button class="btn btn-warning" onclick="checkMultipleOrders()">فحص تعارض المواد الخام</button>
                    </div>
                </div>
            </div>

            <!-- Expiry Section -->
            <div id="expiry" class="section">
                <div class="card">
                    <div class="card-header">المواد الخام قرب تاريخ الانتهاء</div>
                    
                    <div class="input-group">
                        <label>فترة التنبيه (بالأشهر):</label>
                        <input type="number" id="expiryMonths" value="3" min="1" max="12">
                    </div>

                    <button class="btn btn-primary" onclick="checkExpiry()">البحث عن المواد قرب الانتهاء</button>

                    <div id="expiryResults" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="card">
                    <div class="card-header">التقارير</div>
                    
                    <div class="grid">
                        <div class="card">
                            <h3>البحث عن المواد الخام في المنتجات</h3>
                            <div class="input-group">
                                <label>اسم المادة الخام:</label>
                                <input type="text" id="rawMaterialSearch" placeholder="مثال: calcium carbonate">
                            </div>
                            <button class="btn btn-primary" onclick="searchRawMaterial()">بحث</button>
                            <div id="rawMaterialResults"></div>
                        </div>

                        <div class="card">
                            <h3>تقرير المخزون الحالي</h3>
                            <button class="btn btn-primary" onclick="generateStockReport()">إنشاء التقرير</button>
                            <button class="btn btn-success" onclick="exportToExcel('stockReport')">تصدير إلى Excel</button>
                            <div id="stockReport"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productivity Section -->
            <div id="productivity" class="section">
                <div class="card">
                    <div class="card-header">تقارير الإنتاجية</div>
                    
                    <div class="input-group">
                        <label>من تاريخ:</label>
                        <input type="date" id="prodStartDate">
                    </div>

                    <div class="input-group">
                        <label>إلى تاريخ:</label>
                        <input type="date" id="prodEndDate">
                    </div>

                    <div class="input-group">
                        <label>اختر المنتج (اختياري):</label>
                        <select id="prodProduct">
                            <option value="">جميع المنتجات</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="generateProductivityReport()">إنشاء تقرير الإنتاجية</button>
                    <button class="btn btn-success" onclick="exportToExcel('productivityReport')">تصدير إلى Excel</button>

                    <div id="productivityReport" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        const appData = {
            product2Materials: [],
            product14Materials: [],
            sales: [],
            batches: [],
            stock: [],
            mondayRMG: [],
            mondayPowder: [],
            orderQueue: [],
            uploadedFiles: 0,
            reorderPoints: {}
        };

        // Show/Hide tabs
        function showTab(tabName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Handle file upload
        function handleFileUpload(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    // Store data based on file type
                    switch(fileType) {
                        case 'product2':
                            appData.product2Materials = jsonData;
                            break;
                        case 'product14':
                            appData.product14Materials = jsonData;
                            break;
                        case 'sales':
                            appData.sales = jsonData;
                            break;
                        case 'batches':
                            appData.batches = jsonData;
                            break;
                        case 'stock':
                            appData.stock = jsonData;
                            break;
                        case 'monday_rmg':
                            appData.mondayRMG = jsonData;
                            populateProductDropdown();
                            break;
                        case 'monday_powder':
                            appData.mondayPowder = jsonData;
                            break;
                    }

                    // Update UI
                    const fileNum = event.target.id.replace('file', '');
                    const statusElement = document.getElementById(`file${fileNum}-status`);
                    statusElement.classList.add('uploaded');
                    
                    appData.uploadedFiles++;
                    document.getElementById('uploadedCount').textContent = appData.uploadedFiles;
                    document.getElementById('uploadProgress').style.width = 
                        (appData.uploadedFiles / 7 * 100) + '%';

                    showAlert('uploadSuccess');
                    
                    console.log(`${fileType} loaded:`, jsonData.length, 'rows');
                } catch (error) {
                    console.error('Error reading file:', error);
                    showAlert('uploadError');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Show alert
        function showAlert(alertId) {
            const alert = document.getElementById(alertId);
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        // Check reorder points
        function checkReorderPoints() {
            const alertsDiv = document.getElementById('reorderAlerts');
            const productAlertsDiv = document.getElementById('productReorderAlerts');
            alertsDiv.innerHTML = '';
            productAlertsDiv.innerHTML = '';

            // Check raw materials
            const allMaterials = [...appData.product2Materials, ...appData.product14Materials];
            
            allMaterials.forEach(material => {
                const stock = parseFloat(material['ارصدة البضائع']) || 0;
                const reorderPoint = parseFloat(material['اقل طلبية']) || 0;
                const shortage = parseFloat(material['نقص']) || 0;

                if (stock < reorderPoint || shortage > 0) {
                    const alert = document.createElement('div');
                    alert.className = 'notification-item';
                    alert.innerHTML = `
                        <strong>${material['اسم صنف'] || 'مادة غير معروفة'}</strong><br>
                        الرصيد الحالي: ${stock.toFixed(2)} ${material['وحدة التقرير'] || ''}<br>
                        نقطة إعادة الطلب: ${reorderPoint.toFixed(2)}<br>
                        النقص: ${shortage.toFixed(2)}
                    `;
                    alertsDiv.appendChild(alert);
                }
            });

            // Check finished products from stock
            appData.stock.forEach(item => {
                const currentStock = parseFloat(item['الرصيد']) || 0;
                const reorderPoint = appData.reorderPoints[item['الاسم']] || 0;

                if (currentStock < reorderPoint) {
                    const alert = document.createElement('div');
                    alert.className = 'notification-item';
                    alert.style.borderColor = '#28a745';
                    alert.innerHTML = `
                        <strong>${item['الاسم']}</strong><br>
                        الرصيد الحالي: ${currentStock.toFixed(2)} ${item['وحدة التقرير'] || ''}<br>
                        نقطة إعادة الطلب: ${reorderPoint.toFixed(2)}
                    `;
                    productAlertsDiv.appendChild(alert);
                }
            });

            if (alertsDiv.children.length === 0) {
                alertsDiv.innerHTML = '<p style="color: #28a745;">✓ جميع المواد الخام فوق نقطة إعادة الطلب</p>';
            }

            if (productAlertsDiv.children.length === 0) {
                productAlertsDiv.innerHTML = '<p style="color: #28a745;">✓ جميع المنتجات فوق نقطة إعادة الطلب</p>';
            }
        }

        // Check single order
        function checkOrder() {
            const product = document.getElementById('orderProduct').value;
            const quantity = parseFloat(document.getElementById('orderQuantity').value);
            const resultDiv = document.getElementById('orderResult');

            if (!product || !quantity) {
                resultDiv.innerHTML = '<div class="alert alert-danger show">الرجاء إدخال المنتج والكمية</div>';
                return;
            }

            // Find product in materials
            const materials = [...appData.product2Materials, ...appData.product14Materials];
            const requiredMaterials = materials.filter(m => 
                m['اسم صنف'] && m['اسم صنف'].includes(product)
            );

            if (requiredMaterials.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning show">لم يتم العثور على المنتج</div>';
                return;
            }

            let approved = true;
            let reasons = [];
            let html = '<table class="data-table"><thead><tr><th>المادة</th><th>المطلوب</th><th>المتوفر</th><th>الحالة</th></tr></thead><tbody>';

            requiredMaterials.forEach(material => {
                const required = parseFloat(material['الكمية اللازمة للانتاج']) * quantity;
                const available = parseFloat(material['ارصدة البضائع']) || 0;
                const sufficient = available >= required;

                if (!sufficient) {
                    approved = false;
                    reasons.push(`نقص في ${material['اسم صنف']}: المطلوب ${required.toFixed(2)} والمتوفر ${available.toFixed(2)}`);
                }

                html += `
                    <tr style="background: ${sufficient ? '#d4edda' : '#f8d7da'}">
                        <td>${material['اسم صنف']}</td>
                        <td>${required.toFixed(2)} ${material['وحدة التقرير']}</td>
                        <td>${available.toFixed(2)} ${material['وحدة التقرير']}</td>
                        <td><span class="status-badge ${sufficient ? 'status-approved' : 'status-denied'}">
                            ${sufficient ? 'متوفر' : 'غير كافي'}
                        </span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';

            if (approved) {
                html = '<div class="alert alert-success show">✓ الطلب معتمد - جميع المواد متوفرة</div>' + html;
            } else {
                html = '<div class="alert alert-danger show">✗ الطلب مرفوض<br>' + reasons.join('<br>') + '</div>' + html;
            }

            resultDiv.innerHTML = html;
        }

        // Add order to queue
        function addOrderToQueue() {
            const product = document.getElementById('orderProduct').value;
            const quantity = parseFloat(document.getElementById('orderQuantity').value);
            const batch = document.getElementById('orderBatch').value;

            if (!product || !quantity) {
                alert('الرجاء إدخال المنتج والكمية');
                return;
            }

            appData.orderQueue.push({ product, quantity, batch });
            updateOrderQueue();
        }

        // Update order queue display
        function updateOrderQueue() {
            const queueDiv = document.getElementById('orderQueue');
            
            if (appData.orderQueue.length === 0) {
                queueDiv.innerHTML = '<p>لا توجد طلبات معلقة</p>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>المنتج</th><th>الكمية</th><th>رقم الدفعة</th><th>إجراء</th></tr></thead><tbody>';
            
            appData.orderQueue.forEach((order, index) => {
                html += `
                    <tr>
                        <td>${order.product}</td>
                        <td>${order.quantity}</td>
                        <td>${order.batch || '-'}</td>
                        <td><button class="btn btn-danger" onclick="removeFromQueue(${index})">حذف</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            queueDiv.innerHTML = html;
        }

        // Remove from queue
        function removeFromQueue(index) {
            appData.orderQueue.splice(index, 1);
            updateOrderQueue();
        }

        // Check multiple orders for material conflicts
        function checkMultipleOrders() {
            if (appData.orderQueue.length === 0) {
                alert('لا توجد طلبات في القائمة');
                return;
            }

            const materialUsage = {};
            const conflicts = [];

            // Calculate total material usage
            appData.orderQueue.forEach(order => {
                const materials = [...appData.product2Materials, ...appData.product14Materials];
                const requiredMaterials = materials.filter(m => 
                    m['اسم صنف'] && m['اسم صنف'].includes(order.product)
                );

                requiredMaterials.forEach(material => {
                    const materialName = material['اسم صنف'];
                    const required = parseFloat(material['الكمية اللازمة للانتاج']) * order.quantity;
                    
                    if (!materialUsage[materialName]) {
                        materialUsage[materialName] = {
                            total: 0,
                            available: parseFloat(material['ارصدة البضائع']) || 0,
                            unit: material['وحدة التقرير'],
                            orders: []
                        };
                    }
                    
                    materialUsage[materialName].total += required;
                    materialUsage[materialName].orders.push({
                        product: order.product,
                        quantity: order.quantity,
                        required: required
                    });
                });
            });

            // Check for conflicts
            let html = '<h3>نتائج فحص التعارض</h3>';
            html += '<table class="data-table"><thead><tr><th>المادة</th><th>المطلوب الكلي</th><th>المتوفر</th><th>الحالة</th></tr></thead><tbody>';

            for (const [material, data] of Object.entries(materialUsage)) {
                const sufficient = data.available >= data.total;
                
                if (!sufficient) {
                    conflicts.push({
                        material,
                        required: data.total,
                        available: data.available,
                        shortage: data.total - data.available,
                        orders: data.orders
                    });
                }

                html += `
                    <tr style="background: ${sufficient ? '#d4edda' : '#f8d7da'}">
                        <td>${material}</td>
                        <td>${data.total.toFixed(2)} ${data.unit}</td>
                        <td>${data.available.toFixed(2)} ${data.unit}</td>
                        <td><span class="status-badge ${sufficient ? 'status-approved' : 'status-denied'}">
                            ${sufficient ? 'كافي' : 'نقص: ' + (data.total - data.available).toFixed(2)}
                        </span></td>
                    </tr>
                `;
            }

            html += '</tbody></table>';

            if (conflicts.length > 0) {
                html += '<div class="alert alert-warning show" style="margin-top: 20px;"><h4> تعارضات المواد الخام</h4>';
                conflicts.forEach(conflict => {
                    html += `<div style="margin: 15px 0; padding: 10px; background: white; border-radius: 5px;">
                        <strong>${conflict.material}</strong><br>
                        النقص: ${conflict.shortage.toFixed(2)}<br>
                        الطلبات المتأثرة:<ul>`;
                    conflict.orders.forEach(order => {
                        html += `<li>${order.product} - الكمية: ${order.quantity} - يحتاج: ${order.required.toFixed(2)}</li>`;
                    });
                    html += '</ul></div>';
                });
                html += '<p><strong>يرجى تحديد أولوية الطلبات</strong></p></div>';
            } else {
                html += '<div class="alert alert-success show">✓ جميع الطلبات يمكن إنتاجها بدون تعارض</div>';
            }

            document.getElementById('orderQueue').innerHTML += html;
        }

        // Check expiry dates
        function checkExpiry() {
            const months = parseInt(document.getElementById('expiryMonths').value) || 3;
            const resultsDiv = document.getElementById('expiryResults');
            
            const today = new Date();
            const thresholdDate = new Date();
            thresholdDate.setMonth(today.getMonth() + months);

            const expiringMaterials = [];

            appData.batches.forEach(batch => {
                const expiryDate = new Date(batch['تاريخ الانتهاء']);
                
                if (expiryDate <= thresholdDate && expiryDate >= today) {
                    expiringMaterials.push({
                        name: batch['صنف اسم'] || batch['اسم'],
                        quantity: batch['رصيد'],
                        expiryDate: expiryDate,
                        batchNumber: batch['دفعة'],
                        unit: batch['وحدة التقارير']
                    });
                }
            });

            if (expiringMaterials.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-success show">✓ لا توجد مواد قريبة من تاريخ الانتهاء خلال الفترة المحددة</div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>المادة</th><th>الكمية</th><th>رقم الدفعة</th><th>تاريخ الانتهاء</th><th>الأيام المتبقية</th></tr></thead><tbody>';

            expiringMaterials.forEach(material => {
                const daysRemaining = Math.ceil((material.expiryDate - today) / (1000 * 60 * 60 * 24));
                const urgency = daysRemaining < 30 ? '#f8d7da' : daysRemaining < 60 ? '#fff3cd' : '#d4edda';

                html += `
                    <tr style="background: ${urgency}">
                        <td>${material.name}</td>
                        <td>${material.quantity} ${material.unit || ''}</td>
                        <td>${material.batchNumber}</td>
                        <td>${material.expiryDate.toLocaleDateString('ar-SA')}</td>
                        <td>${daysRemaining} يوم</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            html += '<button class="btn btn-primary" onclick="suggestProducts()">اقتراح المنتجات للإنتاج</button>';
            resultsDiv.innerHTML = html;
        }

        // Suggest products that can be made from expiring materials
        function suggestProducts() {
            alert('هذه الميزة تتطلب ربط قاعدة بيانات تركيبة المنتجات. يمكن تطويرها لاحقاً.');
        }

        // Search for raw material in products
        function searchRawMaterial() {
            const searchTerm = document.getElementById('rawMaterialSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('rawMaterialResults');

            if (!searchTerm) {
                resultsDiv.innerHTML = '<div class="alert alert-warning show">الرجاء إدخال اسم المادة</div>';
                return;
            }

            const materials = [...appData.product2Materials, ...appData.product14Materials];
            const foundProducts = new Set();

            materials.forEach(material => {
                const materialName = (material['اسم صنف'] || '').toLowerCase();
                if (materialName.includes(searchTerm)) {
                    // Extract product info from the material
                    foundProducts.add(materialName);
                }
            });

            if (foundProducts.size === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning show">لم يتم العثور على منتجات تحتوي على هذه المادة</div>';
                return;
            }

            let html = '<h4>المنتجات التي تحتوي على: ' + searchTerm + '</h4><ul>';
            foundProducts.forEach(product => {
                html += `<li>${product}</li>`;
            });
            html += '</ul>';

            resultsDiv.innerHTML = html;
        }

        // Generate stock report
        function generateStockReport() {
            const reportDiv = document.getElementById('stockReport');
            
            if (appData.stock.length === 0) {
                reportDiv.innerHTML = '<div class="alert alert-warning show">لم يتم تحميل بيانات المخزون بعد</div>';
                return;
            }

            let html = '<table class="data-table" id="stockReportTable"><thead><tr>' +
                       '<th>الصنف</th><th>العائلة</th><th>الاسم</th><th>الوحدة</th><th>الرصيد</th><th>داخل</th><th>خارج</th></tr></thead><tbody>';

            appData.stock.forEach(item => {
                html += `
                    <tr>
                        <td>${item['صنف'] || ''}</td>
                        <td>${item['عائلة الصنف'] || ''}</td>
                        <td>${item['الاسم'] || ''}</td>
                        <td>${item['وحدة التقرير'] || ''}</td>
                        <td>${item['الرصيد'] || 0}</td>
                        <td>${item['داخل'] || 0}</td>
                        <td>${item['خارج'] || 0}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            reportDiv.innerHTML = html;
        }

        // Generate productivity report
        function generateProductivityReport() {
            const startDate = new Date(document.getElementById('prodStartDate').value);
            const endDate = new Date(document.getElementById('prodEndDate').value);
            const product = document.getElementById('prodProduct').value;
            const reportDiv = document.getElementById('productivityReport');

            if (!startDate || !endDate) {
                reportDiv.innerHTML = '<div class="alert alert-warning show">الرجاء تحديد نطاق التاريخ</div>';
                return;
            }

            const allBatches = [...appData.mondayRMG, ...appData.mondayPowder];
            let filteredBatches = allBatches.filter(batch => {
                const completionDate = new Date(batch['Completion Date']);
                return completionDate >= startDate && completionDate <= endDate;
            });

            if (product) {
                filteredBatches = filteredBatches.filter(b => 
                    (b['Name'] || '').includes(product)
                );
            }

            if (filteredBatches.length === 0) {
                reportDiv.innerHTML = '<div class="alert alert-warning show">لا توجد بيانات للفترة المحددة</div>';
                return;
            }

            // Calculate statistics
            const totalBatches = filteredBatches.length;
            const totalVolume = filteredBatches.reduce((sum, b) => sum + (parseFloat(b['Batch volu. (kg)']) || 0), 0);
            const totalProducts = filteredBatches.reduce((sum, b) => sum + (parseFloat(b['Batch volu. (box)']) || 0), 0);
            const totalTime = filteredBatches.reduce((sum, b) => sum + (parseFloat(b['Preparation time / hours']) || 0), 0);

            let html = `
                <div class="grid">
                    <div class="card">
                        <h3>عدد الدفعات</h3>
                        <h2 style="color: #667eea;">${totalBatches}</h2>
                    </div>
                    <div class="card">
                        <h3>إجمالي الحجم (كغ)</h3>
                        <h2 style="color: #667eea;">${totalVolume.toFixed(2)}</h2>
                    </div>
                    <div class="card">
                        <h3>إجمالي الصناديق</h3>
                        <h2 style="color: #667eea;">${totalProducts.toFixed(0)}</h2>
                    </div>
                    <div class="card">
                        <h3>إجمالي وقت التحضير</h3>
                        <h2 style="color: #667eea;">${totalTime.toFixed(1)} ساعة</h2>
                    </div>
                </div>
                <table class="data-table" id="productivityReportTable">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>العميل</th>
                            <th>رقم الدفعة</th>
                            <th>الحجم (كغ)</th>
                            <th>الصناديق</th>
                            <th>تاريخ الإنجاز</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredBatches.forEach(batch => {
                html += `
                    <tr>
                        <td>${batch['Name'] || ''}</td>
                        <td>${batch['Customer'] || ''}</td>
                        <td>${batch['Batch Number'] || ''}</td>
                        <td>${(batch['Batch volu. (kg)'] || 0)}</td>
                        <td>${(batch['Batch volu. (box)'] || 0)}</td>
                        <td>${batch['Completion Date'] || ''}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            reportDiv.innerHTML = html;
        }

        // Populate product dropdown
        function populateProductDropdown() {
            const select = document.getElementById('prodProduct');
            const products = new Set();

            [...appData.mondayRMG, ...appData.mondayPowder].forEach(batch => {
                if (batch['Name']) {
                    products.add(batch['Name']);
                }
            });

            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                select.appendChild(option);
            });
        }

        // Export to Excel
        function exportToExcel(tableId) {
            const table = document.getElementById(tableId + 'Table');
            if (!table) {
                alert('لا يوجد تقرير لتصديره');
                return;
            }

            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, tableId + '_report.xlsx');
        }

        // Initialize
        window.onload = function() {
            console.log('Production Management System loaded');
        };
    </script>
    
</body>
</html>